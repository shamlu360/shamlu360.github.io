<!DOCTYPE html>
<html>
<head>
    <title>Whisky for New Drinkers!!!</title>
    <meta charset="utf-8" />
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <style type="text/css">
      text{
        cursor: pointer;
      }
    </style>
</head>

<body>
  <h1> Welcome to our page to learn about whisky!</h1>
  <p> Below is the map of whisky, hover your cursor over the country to see the interesting fact of whisky!</p>
  <div id="map"></div>
  <div id="summary"></div>
  <h2> Our database </h2>
  <p> Here is the average score of each country.</p>
  <div id="barchart"></div>
  <h2> A bottle of whisky for you?</h2>
  <p> To find a bottle of whisky for you. First, select the country from the drop down list. Second, select a desired character. Then, we will generate a list of whisky of our suggestion.</p>
  <div id="dropdown"></div>
  <div id="wheel"></div>
  <div id="suggestion"></div>
  <script type="text/javascript">
    d3.queue()
      .defer(d3.json, "whiskymap.json")
      .defer(d3.csv, "whisky_clear.csv")
      .await(doTasks);

    function doTasks(error, whisky_map, whisky_data){
      if (error) throw error;

      // Below is the code for the map and interaction
      var w = 1000,
            h = 400;

        var margin = {top:5, right:5, bottom:100, left:100};

        var map = d3.select("#map")
                    .append("svg")
                    .attr("width",w)
                    .attr("height",h)
                    .append("g")
                    .attr('transform', 'translate(0,0)');

        var g = map.append("g");

        var path = d3.geoPath().projection(d3.geoEquirectangular());

        var summ = d3.select("#summary")
                    .append("svg")
                    .attr("width",w)
                    .attr("height",h)
                    .attr('transform', 'translate(' + w/2 +','+ h/2 + ')')
                    .append("g");

        g.selectAll("path")
           .data(whisky_map.features)
           .enter()
           .append("path")
           .attr("d",path)
           .attr("id", function(d){return d.properties.sovereignt;})
           .style("fill","teal")
           ;


        var country = d3.selectAll("path");

        var mouseoverCountry;

        country.on("mouseover", function(map){
          mouseoverCountry = d3.select(this).attr("id");
          console.log("It works!");
          console.log(mouseoverCountry);

          
          var xPos = parseFloat(d3.select(this).attr("x"));
          var yPos = parseFloat(d3.select(this).attr("y"));

          xPos = 100;
          yPos = 100;

          //console.log("("+xPos+","+yPos+")");
          /*
          g.append("text")
             .attr("id","tooltip")
             .attr("x",xPos)
             .attr("y",yPos)
             .attr("text-anchor", "middle")
             .attr("font-family", "sans-serif")
             .attr("font-size", "11px")
             .attr("font-weight", "bold")
             .attr("fill", "black")
             .text(map.properties.sovereignt);
			*/
          
          summ.append("text")
             .attr("id","summary")
             .attr("x",xPos)
             .attr("y",yPos)
             .attr("text-anchor", "middle")
             .attr("font-family", "sans-serif")
             .attr("font-size", "14px")
             .attr("fill", "black")
             .text(mouseoverCountry);
            
               
        });

        country.on("mouseout", function(map){
          console.log("See you!");
          d3.select("#tooltip").remove();
          d3.select("#summary").selectAll("text")
            .remove();
        })

        // Above is the code for the map and interaction
      
    	/*
		------------------------------------------------------------------
		---------------------Next Chunk Below-----------------------------
		------------------------------------------------------------------
     	*/

    	// data set up
      	whisky_data.forEach(function(d){
            d.whisky = d.whisky;
            d.score = +d.score;
            d.review = +d.review;
            d.cost = +d.cost;
            d.class = d.class;
            d.cluster = d.cluster;
            d.country = d.country;
            d.type = d.type;
        });

      	/*
		------------------------------------------------------------------
		---------------------Next Chunk Below-----------------------------
		------------------------------------------------------------------
      	*/

    	// Below is the code for bar chart

      	margin = {top: 20, right: 20, bottom: 110, left: 40};
      	var width = 700 - margin.left - margin.right,
    		height = 500 - margin.top - margin.bottom;

   		var barChart = d3.select("#barchart")
						 .append("svg")
						 .attr("width", width + margin.left + margin.right)
						 .attr("height", height + margin.top + margin.bottom)
						 .append("g")
						.attr("transform", "translate(" + margin.left+"," + margin.top + ")");

		// unique country with all score				
		var barData = d3.nest()
					  .key(function(d){
							return d.country;
					  })
					  .rollup(function (v) {return v.map(function(d){return d.score;})})
					  .entries(whisky_data);

		//# number of vintage in each country
		var countByCountry = d3.nest()
      						   .key(function(d) { return d.country ; })
      						   .rollup(function(d) { return d.length; })
      						   .entries(whisky_data);

      	//average array
      	var ave = [];
      	for(var i = 0; i < barData.length; i++){
      		ave[i] = d3.sum(barData[i].value)/countByCountry[i].value;
      	}
      	
      	var allArr = [];

      	for(var i = 0; i < barData.length; i++){
      		var user = new Object();
     			user = {country: countByCountry[i].key,
      					average: ave[i]};
      			allArr.push(user);
      	}

      	var xscale = d3.scaleBand()
					   .domain(allArr.map(function(d) {
							return d.country; 
						}))
					   .rangeRound([0,width])
					   .paddingInner(0.2);


		var yscale = d3.scaleLinear()
					   .domain([0, d3.max(allArr, function(d){
							return d.average;
						})])
					   .range([height,0]);
		// Add the x Axis
		barChart.append("g")
      			.attr("transform", "translate(0," + height + ")")
      			.call(d3.axisBottom(xscale))
		 		.selectAll("text")	
     			.style("text-anchor", "end")
       			.attr("dx", ".8em")
  				.style("font-size", "15px") 
        		.attr("dy", ".75em")
       			.attr("transform",  "rotate(-35)");
  		// add the y Axis
  		barChart.append("g")
      			.call(d3.axisLeft(yscale));
      	// Plot the bars
      	barChart.selectAll(".bar")
      			.data(allArr)
    			.enter().append("rect")
      			.attr("class", "bar")
      			.attr("x", function(d) {return xscale(d.country); })
      			.attr("width", xscale.bandwidth())
   				.attr("y", function(d) { return yscale(d.average); })
   				.attr("height", function(d) { return height - yscale(d.average); })
      			.attr("fill", "steelBlue");

      	var worldSum= d3.sum(allArr, function(d) { return d.average;}); 

      	var worldAverage = worldSum/(allArr.length);
      	// Add the average line
      	var line = barChart.append("line")
      					   .attr("x1", 0 )
      					   .attr("x2",2000)
      					   .attr("y1",yscale(worldAverage) )
      					   .attr("y2", yscale(worldAverage))
      					   .attr("stroke-width", 1)
      					   .attr("stroke", "red");
      	// Add data labels
      	barChart.append("g")
      			.selectAll("text")
      			.data(allArr)
      			.attr("class","bar")
      			.enter()
      			.append("text")
      			.attr("x", function(d,i){
      				return xscale(d.country)+5;
      			 })
			 	.attr("y",function(d){
			 		return yscale(d.average)+40;
			 	})
				.text(function(d){return d.average.toFixed(2);})
			 	.attr("font-family", "sans-serif")
   				.attr("font-size", "10px")
   				.attr("fill", "white");
   		// Label y axis title
   		barChart.append("g")
   					.append("text")
      				.attr("transform", "rotate(-90)")
      				.attr("y", 0 - margin.left)
      				.attr("x",0 - (height / 2))
      				.attr("dy", "1em")
      				.style("text-anchor", "middle")
      				.text("Average Score of All Whiskey");  
      	// Label x axis title
      	barChart.append("g")
      			.append("text")             
      			.attr("transform",
            		"translate(" + (width/2) + " ," + 
                          (height + margin.top + 65) + ")")
     			.style("text-anchor", "middle")
      			.text("Country");

      	// Label world average line
      	barChart.append("g")
   				.append("text")
      			.attr("y", 0)
      			.attr("x",yscale(worldAverage) + 580)
      			.attr("dy", "1em")
      			.style("text-anchor", "middle")
   				.style("font-size", "12px")
      			.style("fill", "red")
   				.text("world average " + worldAverage.toFixed(2));

      /*
		------------------------------------------------------------------
		---------------------Next Chunk Below-----------------------------
		------------------------------------------------------------------
      */

      // Below is the code for suggestion and interaction
        var character = [
          {"flavor":"Fruity", "color":"green","share":1},
          {"flavor":"Smoky", "color":"gray","share":1}
        ]; // Text and color set up for the wheel

        // Canvas size set up
        var margin = {top:5, right:5, bottom:100, left:100};
        var w_wheel = 400,
            h_wheel = 400;

        var w_suggestion = 1200,
            h_suggestion = 800;

        // Set up #wheel
        var wheel = d3.select("#wheel")
              .append("svg")
              .attr("width",w_wheel)
              .attr("height",h_wheel)
              .attr("transform","translate(0,0)");

        var radius = w_wheel/2;

        var path = d3.arc()
              .innerRadius(0)
              .outerRadius(radius);

        var pie = d3.pie().value(function(d){return d.share;});


        var arcs = wheel.selectAll("g.arc")
                   .data(pie(character))
                   .enter()
                   .append("g")
                   .attr("class","slice")
                   .attr("transform","translate(" + radius + "," + radius +")");

        arcs.append("path")
            .attr("d", path)
            .attr("fill",function(d){return d.data.color;});

        arcs.append("text")
            .attr("transform", function(d){return "translate(" + path.centroid(d) + ")";})
            .attr("dy",".35em")
            .style("text-anchor","middle")
            .text(function(d){return d.data.flavor;})
            .style("stroke","white");

        // Set up the table on #suggestion
        var suggestion = d3.select("#suggestion")
                   .attr("width",w_suggestion)
                   .attr("height",h_suggestion);

        var tabulate = function(data,columns){
          var table = suggestion.append("table");
          var thead = table.append("thead");
          var tbody = table.append("tbody");

          thead.append("tr")
             .selectAll("th")
             .data(columns)
             .enter()
             .append("th")
             .text(function(d){return d;});

          var rows = tbody.selectAll("tr")
                  .data(data)
                  .enter()
                  .append("tr");

          var cells = rows.selectAll("td")
                  .data(function(row){
                    return columns.map(function(col){
                      return {column: col, value: row[col]};
                    })
                  })
                  .enter()
                  .append("td")
                  .text(function(d){return d.value;});

          return table;
        }

          

          var dropdown_option = d3.nest().key(function(d){return d.country;})
                    .rollup(function(d){return d.length;})
                    .entries(whisky_data); 

          var selection = d3.select("#dropdown");

          selection.append("select")
               .selectAll("option")
               .data(dropdown_option)
               .enter()
               .append("option")
               .attr("value",function(d){return d.key;})
               .text(function(d){return d.key;});

          // Interaction for user to select country and flavor to filter
          // Default selection to Scotland
          var selectedCountry = "Scotland";
          console.log(selectedCountry);

          var selectedFlavor;

          
          selection.on("change",function(){

            selectedCountry = d3.select(this)
                      .select("select")
                      .property("value");

            console.log(selectedCountry);

            var result = whisky_data.filter(function(d){return d.country == selectedCountry;});

            var table = tabulate(result,col);
            table.selectAll("thead th")
             .text(function(col){return col.charAt(0).toUpperCase()+col.substr(1);});
          })


          wheel.selectAll(".slice").on("click",function(d){
            selectedFlavor = d.data.flavor;
              //console.log(d.data.flavor);
              //console.log(selectedCountry);
              console.log(selectedFlavor);
          });
          //console.log("Outside is " + selectedFlavor);

          var result = whisky_data.filter(function(d){return d.country == selectedCountry;});
          //console.log(result);


          //console.log(result)
          var col = ["whisky","score","review","cost","cluster","class","country","type"];

          

          //var table = tabulate(result,col); // Generate a table of suggestion
          



          //table.selectAll("thead th")
          //   .text(function(col){return col.charAt(0).toUpperCase()+col.substr(1);});


          // Above is the code for suggestion and interaction
      	  /*
			------------------------------------------------------------------
			---------------------Next Chunk Below-----------------------------
			------------------------------------------------------------------
      	  */

		} // End function
  </script>

</body>
</html>
